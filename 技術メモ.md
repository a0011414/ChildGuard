# ChildGuard 技術メモ

技術選定・アーキテクチャのメモ。随時追記・修正。

---

## 当座の前提（2026-02-26）

- **対象端末**: **iPhone（iOS）** で動くものを想定。
- **実装言語**: **Swift**（ネイティブ iOS アプリとして）。
- **アプリの役割**: ルールをアプリ内で書き込み・保存し、そのルールに従って制御・通知する（要件メモ.md 参照）。

---

## ルールの保存場所：iCloud（CloudKit）

iPhone 利用者は通常 iCloud（Apple ID）を持っているため、**ルールを iCloud に置く**方針で検討する。

### 保存・同期の仕組み

- **CloudKit** でアプリのデータを iCloud に保存・同期する。
- ルールを CloudKit のレコード（または SwiftData / Core Data + CloudKit）として保存する。
- 同一 Apple ID の複数デバイスでは、同じデータが自動で同期される。

### 親の iPhone で編集 → 子の iPhone に反映

親と子が**別 Apple ID** の場合、CloudKit の **共有（CKShare）** を使う。

| 役割 | 動き |
|------|------|
| **親の iPhone** | ルールを編集し、親のプライベート DB に保存。そのルール（またはルールのまとまり）を**子の Apple ID に CKShare で共有**する。 |
| **共有の権限** | 参加者（子）の権限を **読み取り専用（ReadOnly）** にできる。親＝編集可、子＝参照のみ。 |
| **子の iPhone** | 子のアプリは Shared Database からその共有データを読み、ルールを取得して制限・通知に使う。 |

つまり「親の iPhone で書き換える → iCloud で共有 → 子の iPhone のアプリがそのルールを読んで適用」という流れにできる。

### 注意点

- 子には**共有招待を一度受けてもらう**（承諾）必要がある。
- オフライン時は、最後に同期されたルールが使われる。

### 共有のオンボーディング方針（実装前チェックで決定）

- **よくあるペアレンタルコントロールの方法**でよい。親が「子どもを追加」して共有を送る → 子の端末に招待が届く → 子が承諾する流れ。子モード初回または設定に「親から共有が届いたら承諾してください」の案内を入れる。

---

## iOS で「制御」をどう実現するか（Family Controls 等）

第三者がアプリの利用時間を止めたり制限したりするには、Apple の **Family Controls / ManagedSettings / DeviceActivity** が前提になる。調査結果の要約。

### 使うのに必要なこと

- **Apple への事前申請が必須**  
  Family Controls を使うアプリは、**Family Controls & Personal Device Usage Entitlement Request** を Apple に申請し、許可を得る必要がある。TestFlight や App Store 配布前に申請が必要。
- **制限は「制限をかける端末」で動く**  
  ManagedSettings / DeviceActivity は、**制限をかけられる側（子の iPhone）** にアプリ（または App Extension）が入っていないと効かない。親の iPhone だけでなく、**子の iPhone にも同じアプリ（または子用アプリ）をインストールする必要がある**。

### 主な API の役割

| フレームワーク | 役割 |
|----------------|------|
| **FamilyControls** | 認可の取得、アプリ・カテゴリ・Webサイトの選択 UI（FamilyActivityPicker） |
| **ManagedSettings** | 選択したアプリ・Webを「シールド」でブロックする（制限の適用） |
| **DeviceActivity** | 指定した時間帯やイベント（例：1日〇分使用）のモニタリング。**DeviceActivityMonitor** は App Extension でバックグラウンド動作 |

### 制限・制約の例

- **DeviceActivity**: スケジュール登録は最大 20 件。最小 15 分・最大 1 週間のインターバル。
- **ManagedSettingsStore**: アプリ・Web ドメイン・カテゴリなど、各項目ごとに最大 50 件までなど。
- **本体アプリと Extension**: データは自動共有されない。**App Groups** や UserDefaults 等で共有する必要がある。
- **配布**: ManagedSettings / DeviceActivity を使うアプリは、配布前に Apple に **distribution entitlement** の申請が必要（別途）。

### アプリ構成への示唆

- 制限は**子の iPhone 上**でかかるため、**子の iPhone にもアプリを入れる**必要がある。
- 親用・子用を **1 本のアプリで「モード切り替え」** にするか、**親用アプリと子用アプリを分ける**かは実装次第。いずれにしても、子の端末で DeviceActivityMonitor Extension 等が動く構成になる。
- **決定**: **1 本のアプリ**で親子モード切り替え（実装前チェック 2026-02-26）。

---

## 親への通知：LINE / WhatsApp と MCP（検討メモ）

「制限がかかった」ことを親に伝える手段として、会話で出た方針をメモしておく。

- **日本向け**  
  **LINE** を第一候補。LINE Messaging API で通知。親は LINE 公式アカウント（ボット）で受け取る。
- **世界展開**  
  **WhatsApp**（WhatsApp Business Platform / Cloud API）。欧州・南米・インド等で一般的。
- **実装の形**  
  - **通知用 MCP サーバー**を用意し、「LINE を送る」「WhatsApp を送る」などを**ツール**として公開する。  
  - iPhone アプリは **MCP クライアント**として、DeviceActivity で制限到達を検知したタイミングで、そのツールを呼び出す。  
  - 国・地域に応じて接続する MCP サーバーやツールを切り替えれば、アプリ本体のロジックを変えずに通知先を増やせる。
- **通知文の生成**  
  定型文で十分ならそのまま。のちに「温かみのある報告」「多言語」にしたい場合は、オンデバイス LLM（例: Gemma を Core ML / MLX Swift で）で文を生成してから MCP 経由で送る、といった拡張が可能。
- **開発の順番**  
  まず LINE 用の MCP サーバーを 1 本立てて、送信が動くようにする。動いたら WhatsApp 用ツールを同じサーバーに追加していくのが効率的。

※ 最小プロトでは「MCP は使わない」方針のまま、通知は後から MCP で拡張する形でよい。

---

## 未定・要検討

- **MCP（エージェント）の載せ先**  
  最小プロトでは **MCP は使わない**（Swift でルールを読んで iOS API に渡す）。のちに MCP を組み込む場合の候補：端末内／自宅サーバ／クラウド。**親への通知**は、上記のとおり MCP サーバー（LINE / WhatsApp ツール）を用意してクライアントから呼ぶ形が拡張しやすい。

---

## メモ

- のちに Android や他端末を考える場合は、共通ロジックの分離やクロスプラットフォームの検討が必要になるが、当座は iOS に集中してよい（引き継ぎ.md のスコープ）。
