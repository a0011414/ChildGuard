# Family Controls 申請メモ（ChildGuard）

Family Controls & Personal Device Usage の配布用 Entitlement を申請するときの手順とメモ。  
**申請は Apple Developer アカウントでログインし、フォームから送信する必要があります。**

**✅ 承認済み**。Xcode で Family Controls を有効化し、Device Activity / Managed Settings の実装へ。必要な情報・手順は下記「承認後：必要な情報と手順」を参照。

---

## 申請フォーム URL

- **https://developer.apple.com/contact/request/family-controls-distribution**

（Apple Developer にサインインしていない場合は、先にサインインしてから上記を開く。）

---

## 申請前に確認すること

- [ ] **Apple Developer Program に加入済み**（Account Holder であること）
- [ ] **Bundle ID を確定している**（下記のとおり）
- [ ] アプリの目的・使い方を簡潔に説明できる

### ChildGuard の識別情報（申請フォーム記入用）

| 項目 | 値 |
|------|-----|
| **アプリ名** | ChildGuard |
| **Bundle ID** | `com.yoshi.ChildGuard` |
| **用途** | 家庭内のペアレンタルコントロール（親子で決めたルールに従った使用時間の管理・制限） |

---

## フォームの「App Apple ID」と「Website」の記入方法

### App Apple ID

**App Apple ID** は、App Store Connect でアプリを追加したときに自動で付く**数字だけの ID** です（Bundle ID とは別物）。

#### まだ App Store Connect にアプリを追加していない場合

1. **Bundle ID の登録**  
   [developer.apple.com/account](https://developer.apple.com/account) → **Certificates, Identifiers & Profiles** → **Identifiers** → **App IDs** で、`com.yoshi.ChildGuard` が登録されているか確認。なければ **+** で「App」を選び、Bundle ID を登録する。
2. **App Store Connect でアプリを追加**  
   [appstoreconnect.apple.com](https://appstoreconnect.apple.com) → **マイアプリ** → **+** → **新規アプリ**。プラットフォームは iOS、名前は「ChildGuard」、Bundle ID で `com.yoshi.ChildGuard` を選び、SKU は任意（例: `childguard001`）で作成。
3. **App Apple ID を確認**  
   作成したアプリを開く。**アプリ情報**（App Information）の画面に **Apple ID** という項目があり、**数字のみ**（例: `1234567890`）が表示される。または、ブラウザの URL が `appstoreconnect.apple.com/apps/数字/...` になっていれば、その**数字**が App Apple ID。
4. フォームの **App Apple ID** 欄に、その**数字だけ**を入力する。

#### すでにアプリを追加済みの場合

App Store Connect → **マイアプリ** → **ChildGuard** を開く → **アプリ情報**タブで **Apple ID** の数字を確認し、その値をフォームに記入する。

---

### Website

フォームの **Website** は、アプリや開発者を説明する Web ページの URL を指すことが多いです。

- **公開しているサイトがある場合**  
  アプリの説明やプライバシーポリシーがあるページの URL を記入する（例: GitHub Pages、自社サイト、README の URL など）。
- **まだサイトがない場合**  
  - **任意（optional）** と書いてあれば、空欄のまま送信できる場合がある。  
  - **必須**の場合は、例えば次のいずれかを入れる：  
    - **GitHub のリポジトリ URL**（例: `https://github.com/あなたのID/ChildGuard`）。README にアプリの説明があればそれで足りることが多い。  
    - **GitHub Pages** や **Notion 公開ページ**など、アプリ名と簡単な説明・「個人・家族利用向け」の一文がある 1 ページの URL。  
  - どうしても URL が必要で用意できない場合は、`https://github.com/` のように開発者プロフィールや組織のトップを入れておき、備考欄に「App-specific website to be added before release」などと書く方法もある（フォームに備考欄があれば）。

ChildGuard は自宅・家族向けなので、「商用サイトはないが、必要ならリリース前に説明ページを用意する」旨を説明できれば十分なことが多いです。

---

## 申請文の下書き（目的・説明用）

フォームに「アプリの目的」「どのように Family Controls を使うか」を書く欄がある場合の下書きです。必要に応じて短くしたり、英語で書き直して使ってください。

---

**アプリの目的（日本語案）**

> ChildGuard は、家庭内で親と子が決めたルールに基づき、子どものデバイス利用を管理するアプリです。親が「1日あたりの利用時間」などのルールを設定し、子の iPhone に共有します。子の端末では、そのルールに従って使用時間のモニタリングと、超過時または超過しそうなときの通知・制限を行います。Family Controls（DeviceActivity / ManagedSettings）を用いて、ルールに基づく利用時間の検知とアプリ・Web の制限を実現します。自宅・家族向けの利用を想定しており、商用目的ではありません。

---

**短い英文案（Purpose / How you use Family Controls）**

> ChildGuard is a parental control app for families. Parents set rules (e.g. daily screen time limits) and share them to the child's device via iCloud. On the child's device, the app uses Family Controls (DeviceActivity, ManagedSettings) to monitor usage and apply shields when limits are reached or about to be exceeded. Intended for home/family use only; not for commercial distribution.

---

## 「Your account can't access this page」と表示されるとき（未同意の契約の探し方）

Family Controls 申請フォームで上記メッセージが出る場合、**最新の Apple Developer Program 使用許諾契約に未同意**の可能性が高い。Account Holder が次の場所を順に確認する。

### 1. デベロッパアカウントのトップ（developer.apple.com）

1. **https://developer.apple.com/account/** を開く（Account Holder の Apple ID でログイン済みであること）。
2. ページ**上部**や**右側**に、  
   **「The Apple Developer Program License Agreement has been updated」** のような文言と **「Review Agreement」** ボタンが出ていないか確認する。
3. あれば **Review Agreement** → 内容を読む → チェックを入れる → **I Agree** で同意。

### 2. App Store Connect（契約・請求）

1. **https://appstoreconnect.apple.com/** を開く（同じ Apple ID でログイン）。
2. ホーム画面に **「The updated Apple Developer Program License Agreement needs to be reviewed」** のようなアラートが出ていないか確認する。
3. 左メニュー（またはホームのカード）から **「ビジネス」**（**Agreements, Tax, and Banking**）を開く。
4. **「契約」**（Agreements）タブで、**Paid Apps** 以外に **要確認・要同意** の行（「同意する」「View and Agree to Terms」など）がないか確認する。  
   ※ Program License Agreement の更新がここに出る場合がある。

### 3. 直接 URL で契約一覧を開く

- **https://appstoreconnect.apple.com/agreements/**  
  上記にアクセスし、未完了・要対応の契約が一覧にないか確認する。

### 4. それでも見つからない場合

- **別ブラウザ**や**シークレットウィンドウ**で developer.apple.com と App Store Connect に再ログインして、同じ場所を再度確認する。
- **iPhone / iPad の Apple Developer アプリ**でログインし、**本人確認**や**契約の確認**を促す画面が出ていないか確認する（出た場合はそこで同意）。
- 上記でどこにも未同意の表示がない場合は、**Apple Developer サポート**（[developer.apple.com/contact](https://developer.apple.com/contact)）から「Family Controls 申請ページにアクセスできない。Program License Agreement の同意状況を確認したい」と問い合わせる方法がある。

---

## 申請時の注意

1. **Bundle ID は 1 申請につき 1 つ**  
   メインアプリと App Extension で別 Bundle ID の場合は、それぞれ申請が必要なことがある。

2. **審査期間**  
   おおよそ **3 週間〜数週間〜1 ヶ月程度**。返答まで連絡がない場合もある。

3. **ケース ID が付かない場合**  
   フォーム送信後、追跡用のケース ID が表示されないことがある。メールで受領・審査結果の連絡が来る想定。

4. **TestFlight / App Store 配布**  
   開発用の Entitlement だけでは配布できない。**配布用（distribution）の申請**をし、承認されてから TestFlight や App Store に出す。

5. **本番サイト**  
   審査で「アプリの説明やプライバシーが分かるサイト」を求められることがある。必要なら、簡単な LP や README を公開している URL を用意しておくとよい。

---

## 承認後：必要な情報と手順

承認されると、**追加で「情報」をもらうことはほぼありません**。メールで「許可した」旨の連絡が来て、Developer アカウント側でその Bundle ID に Family Controls（配布用）が使えるようになるだけです。トークンやキーを新たに取得する必要はありません。

### やること一覧

| 項目 | 内容 |
|------|------|
| **1. Xcode で Capability を有効化** | ターゲット **Signing & Capabilities** → **+ Capability** → **Family Controls** を追加する。これで Entitlement に `com.apple.developer.family-controls` が付く。 |
| **2. 使うフレームワーク** | **FamilyControls**（認可・FamilyActivityPicker）、**ManagedSettings**（シールドでブロック）、**DeviceActivity**（使用時間の監視・イベント）。 |
| **3. Device Activity 用の Extension** | 「1日〇分で制限」のような**しきい値ベース**の監視には **Device Activity Monitor** の **App Extension** がいる。Xcode で新規ターゲット「Device Activity Monitor Extension」を追加する。 |
| **4. 本体と Extension でデータ共有** | ルール（何分まで、どのアプリを制限するか）は本体で持ち、Extension から参照する必要がある。**App Groups** を有効化し、同じ App Group を本体と Extension の両方で指定する。UserDefaults(suiteName:) や共有コンテナでルール・選択したアプリのトークンを渡す。 |
| **5. 認可の流れ** | **子の端末**で、**AuthorizationCenter.shared.requestAuthorization(completionHandler:)** を呼ぶ。ファミリー共有の許可ダイアログが出て、ユーザーが許可すると以降 FamilyActivityPicker や DeviceActivity が使える。 |
| **6. アプリ選択の保存** | **FamilyActivityPicker** で選んだ結果（`Set<ActivityCategoryToken>` やアプリトークン）は、**不透明なトークンのまま** App Group の UserDefaults などに保存し、Extension 側の ManagedSettingsStore で `store.shield.applications = ...` に渡す。 |

### 実装の流れ（最初の 1 ルール）

1. **認可** … 子モードで「保護者による管理を許可」のようなボタンから `requestAuthorization` を呼ぶ。
2. **対象アプリの選択** … FamilyActivityPicker で制限したいアプリを選ばせ、そのトークンを App Group で保存。
3. **ルール（1日〇分）の保存** … 既存の CloudKit/UserDefaults の「1日〇分」と、上記トークンを Extension から読めるようにする。
4. **Device Activity のスケジュール** … 監視したい「インターバル」（例：1日 0:00 〜 23:59 のうち、使用が〇分に達した時点）を `DeviceActivityCenter().startMonitoring(...)` で登録。Extension の **DeviceActivityMonitor** で `intervalDidEndThreshold` などを実装し、そこで ManagedSettings でシールドをかけ、必要なら親へ通知（のちに LINE 等）。

### 参照

- [Family Controls | Apple Developer](https://developer.apple.com/documentation/familycontrols)
- [DeviceActivity | Apple Developer](https://developer.apple.com/documentation/deviceactivity)
- [ManagedSettings | Apple Developer](https://developer.apple.com/documentation/managedsettings)
- 技術メモ: `技術メモ.md` の「iOS で制御をどう実現するか」

---

## 申請後の TODO（プロジェクト側）

- ~~承認されたら~~ **承認済み**。Xcode の **Signing & Capabilities** に **Family Controls** を追加し、**DeviceActivity** / **ManagedSettings** の実装を進める。
- 最初の 1 ルール: 「〇時間超えそうなので止めた」→ 親に通知 → 自動で使用制限（TODO.md の「Family Controls 実装」に対応）。

---

## 参照

- 技術メモ: `技術メモ.md` の「iOS で制御をどう実現するか（Family Controls 等）」
- Apple: [Family Controls | Apple Developer](https://developer.apple.com/documentation/familycontrols)
